<%- include('../partials/header.ejs')%>
<main>
    <div class="course-header">
        <h2>Welcome to <%= course.courseName %></h2>
            <a href="/courses/<%= course.id %>/schedule" class="button" id="add-schedule-button">View Schedule</a>
    </div> 
    <div class="queue-container"> 
        <p>Here is where you will find information about the queue</p>
            <% if (questions.length) { %>
                <div class="question-grid">
                  <% questions.forEach(question => { %>
                    <div class="question-container">
                      <div class="tag">
                        <p id="tag"><%=question.tag %></p>
                      </div>
                      <div class="studentName">
                        <p><%=question.user.fullName%></p>
                      </div>
                      <div class="question">
                        <p><%=question.text%></p>
                      </div>
                      <button class="claim">Claim</button>
                    </div>
                  <% }); %>
                </div>
              <% } else { %>
                <p class="noQuestions">There are no questions to display</p>
              <% } %>
    </div>
</main>
<script>
  const socket = new WebSocket('ws://localhost:3000');

  socket.onopen = () => {
      console.log('Connected to WebSocket server');
  };

  socket.onmessage = (event) => {
      question = JSON.parse(event.data);
      if(question.eventType == 'newQuestion'){
        addQuestionToDom(question);
      }
  };

  // Handle WebSocket errors
  socket.onerror = (error) => {
      console.error('WebSocket error:', error);
  };

  // Handle connection closure
  socket.onclose = () => {
      console.log('WebSocket connection closed');
  };

  function addQuestionToDom(question){
    console.log('reached function');
    const noQuestions = document.getElementsByClassName('noQuestions')[0];
    let questionGrid;
    if(noQuestions){
      noQuestions.remove();
      questionGrid = document.createElement('div');
      questionGrid.classList.add('question-grid');
      const queueContainer = document.getElementsByClassName('queue-container')[0];
      queueContainer.appendChild(questionGrid);
    }else{
      questionGrid = document.getElementsByClassName('question-grid')[0];
    }
    
    const questionContainer = document.createElement('div')
    questionContainer.classList.add('question-container');

    const tagDiv = document.createElement('div')
    tagDiv.classList.add('tag');
    const tagP = document.createElement('p')
    tagP.id = 'tag';
    tagP.textContent = question.tag;
    console.log(tagDiv);
    tagDiv.appendChild(tagP);

    const nameDiv = document.createElement('div');
    nameDiv.classList.add('studentName');
    const nameP = document.createElement('p')
    nameP.textContent = question.fullName;
    nameDiv.appendChild(nameP);

    const textDiv = document.createElement('div')
    textDiv.classList.add('question');
    const textP = document.createElement('p');
    textP.textContent = question.text;
    textDiv.appendChild(textP);

    const btn = document.createElement('button')
    btn.classList.add('claim');
    btn.textContent = 'Claim';

    questionContainer.appendChild(tagDiv);
    questionContainer.appendChild(nameDiv);
    questionContainer.appendChild(textDiv);
    questionContainer.appendChild(btn);

    questionGrid.appendChild(questionContainer);
    console.log('addition complete');
  }

</script>
<%- include('../partials/footer.ejs')%>